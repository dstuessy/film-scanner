{{define "body"}}
<div
  class="grow relative flex flex-col justify-center"
  style="
    background-image: url(&quot;/capture/stream&quot;);
    background-repeat: no-repeat;
    background-size: contain;
    background-position: center;
  "
>
  <canvas id="stream-canvas" class="w-full" style="aspect-ratio: 16/9"></canvas>
  <div class="absolute bottom-4 end-0 start-0 text-center">
    <button
      id="scan-button"
      hx-post="/capture/scan?project={{ .ProjectId }}&x=0&y=0&w=0&h=0"
      hx-disabled-elt="this"
      hx-swap="none"
      class="group grow-0 shrink-0 relative w-16 h-16 rounded rounded-full overflow-hidden disabled:opacity-70"
    >
      <span
        class="absolute top-0 start-0 inline-block h-full w-full border border-4 border-black dark:border-white rounded rounded-full"
      >
        <span
          class="absolute top-0 start-0 w-full h-full dark:bg-white opacity-20"
        ></span>
      </span>
      <span
        class="invisible group-disabled:visible absolute top-0 start-0 inline-block h-full w-full p-5 animate-spin text-center"
      >
        <svg
          class="h-full w-full dark:fill-white"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
        >
          <path
            d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm8 12c0 4.418-3.582 8-8 8s-8-3.582-8-8 3.582-8 8-8 8 3.582 8 8zm-19 0c0-6.065 4.935-11 11-11v2c-4.962 0-9 4.038-9 9 0 2.481 1.009 4.731 2.639 6.361l-1.414 1.414.015.014c-2-1.994-3.24-4.749-3.24-7.789z"
          />
        </svg>
      </span>
    </button>
  </div>
</div>
{{end}} {{define "footer"}}
<a
  href="/project/{{ .ProjectId }}"
  class="ms-auto inline-flex items-center p-3 px-5 border border-2 border-black dark:border-white rounded rounded-md"
>
  <svg
    class="dark:fill-white -ms-2 me-2 w-4"
    width="24"
    height="24"
    xmlns="http://www.w3.org/2000/svg"
    fill-rule="evenodd"
    clip-rule="evenodd"
    viewBox="0 0 24 24"
  >
    <path
      d="M20 .755l-14.374 11.245 14.374 11.219-.619.781-15.381-12 15.391-12 .609.755z"
    />
  </svg>
  <span> Project </span>
</a>
{{end}} {{ define "scripts" }}
<script>
  const scanButton = document.getElementById("scan-button");
  const scanUrl = new URL(
    scanButton.getAttribute("hx-post"),
    document.location.origin,
  );
  const streamCanvas = document.getElementById("stream-canvas");
  const ctx = streamCanvas.getContext("2d");
  const rectColor = "magenta";
  const cropRect = { x: 0, y: 0, w: 0, h: 0 };
  let mouseDown = false;

  streamCanvas.width = streamCanvas.clientWidth;
  streamCanvas.height = streamCanvas.clientHeight;

  const draw = () => {
    streamCanvas.width = streamCanvas.width; // clear canvas

    ctx.strokeStyle = rectColor;
    ctx.strokeRect(cropRect.x, cropRect.y, cropRect.w, cropRect.h);

    requestAnimationFrame(draw);
  };

  requestAnimationFrame(draw);

  streamCanvas.addEventListener("mousedown", (e) => {
    const { x, y } = relativeCoordinatesForEvent(e);
    cropRect.x = x;
    cropRect.y = y;
    mouseDown = true;
  });

  streamCanvas.addEventListener("mousemove", (e) => {
    if (mouseDown) {
      const { x, y } = relativeCoordinatesForEvent(e);
      cropRect.w = x - cropRect.x;
      cropRect.h = y - cropRect.y;
    }
  });

  window.addEventListener("mouseup", (e) => {
    mouseDown = false;
    const { width: streamWidth, height: streamHeight } =
      streamCanvas.getBoundingClientRect();

    scanUrl.searchParams.set("x", cropRect.x / streamWidth);
    scanUrl.searchParams.set("y", cropRect.y / streamHeight);
    scanUrl.searchParams.set("w", cropRect.w / streamWidth);
    scanUrl.searchParams.set("h", cropRect.h / streamHeight);
    scanButton.setAttribute("hx-post", scanUrl.toString());
    if (typeof htmx !== "undefined") {
      htmx.process(scanButton);
    }
  });

  window.addEventListener("resize", () => {
    streamCanvas.width = streamCanvas.width;
    streamCanvas.height = streamCanvas.height;
  });

  function relativeCoordinatesForEvent(mouseEvent) {
    const boundingRect = streamCanvas.getBoundingClientRect();
    return {
      x: mouseEvent.clientX - boundingRect.left,
      y: mouseEvent.clientY - boundingRect.top,
    };
  }
</script>
{{ end }}
